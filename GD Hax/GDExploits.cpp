#include "GDExploits.hpp"

stat_edits::StatLinkedList* stat_edits::get_stat_addr(driver& game, StatInfo* instance, StatType stat) {
    const uint64_t list_length = game.read<uint64_t>(&instance->list_length);
    if (list_length == 0 || list_length > 100000)
        return nullptr;

    uint64_t hash = hash_number(game, instance, reinterpret_cast<uint8_t*>(&stat));
    StatLinkedList** stat_table = game.read<StatLinkedList**>(&instance->stat_table);
    if (stat_table == nullptr)
        return nullptr;

    StatLinkedList* cur = game.read<StatLinkedList*>(&stat_table[hash + 1]);
    if (cur == nullptr)
        return nullptr;

    void* end = game.read<void*>(&instance->list_end);
    if (end == nullptr)
        return nullptr;

    if (cur == end)
        return nullptr;

    StatLinkedList* v12 = game.read<StatLinkedList*>(&stat_table[hash]);
    if (v12 == nullptr)
        return nullptr;

    if (stat != game.read<StatType>(&cur->stat)) {
        const uint64_t max_iters = list_length + 2;
        for (uint64_t i = 0; i < max_iters && cur != v12; ++i) {
            cur = game.read<StatLinkedList*>(&cur->next);
            if (cur == nullptr || cur == end)
                return nullptr;

            if (stat == game.read<StatType>(&cur->stat))
                break;
        }

        if (stat != game.read<StatType>(&cur->stat))
            return nullptr;
    }

    return cur;
    /* there is more code beyond this, but it all seems to be logic for adding new items to the hashtable, so im not gonna bother */
}

// hash number using fnv64-1a algorithm (algo used in many games bc of how fast it generates hashes)
uint64_t stat_edits::hash_number(driver& game, StatInfo* instance, uint8_t* number) {
    const uint64_t mask = game.read<uint64_t>(&instance->hash_mask);
    uint64_t hash = 0xCBF29CE484222325;
    const uint64_t prime = 0x100000001B3;

    // normally this algo is used with strings, but rob uses it to hash ints so the length is hardcoded to 4
    for (int i = 0; i < 4; ++i) {
        hash ^= number[i];
        hash *= prime;
    }

    uint64_t result = hash & mask;
    return 2 * result;
}